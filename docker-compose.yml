services:
  # --- INFRASTRUCTURE ---
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "${REDIS_PORT}:6379"
    networks:
      - coral-network
    restart: unless-stopped

  # --- FRONTEND & BACKEND ---
  frontend-react:
    build:
      context: ./frontend-react
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL:-http://localhost:${BACKEND_PORT}}
        - REACT_APP_WS_URL=${REACT_APP_WS_URL:-ws://localhost:${BACKEND_PORT}}
        - PUBLIC_URL=${PUBLIC_URL:-/}
    image: frontend-react
    container_name: frontend-react
    ports:
      - "${FRONTEND_PORT}:3000"
    environment:
      - NODE_ENV=production
    networks:
      - coral-network
    restart: unless-stopped
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: backend
    container_name: backend
    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"
    volumes:
      - coral-data:/data
      - ./backend/logs:/app/logs
    environment:
      - REDIS_URL=redis://redis:${REDIS_PORT}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:${FRONTEND_PORT},:${FRONTEND_PORT}}
      - PROMPTED_SEGMENTATION_BACKEND_URL=http://prompted-seg-service:${PROMPTED_SEG_PORT}
      - SEMANTIC_SEGMENTATION_BACKEND_URL=http://semantic-seg-service:${SEMANTIC_SEG_PORT}
      - COMPLETION_SEGMENTATION_BACKEND_URL=http://instance-discovery-service:${INSTANCE_DISC_PORT}
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run --upgrade fastapi run main.py --port ${BACKEND_PORT}
    depends_on:
      - redis
      - prompted-seg-service
      - semantic-seg-service
      - instance-discovery-service

  # --- AI SERVICES & THEIR DEDICATED WORKERS ---

  # 1. Prompted Segmentation
  prompted-seg-service:
    build:
      context: ./prompted-seg-service
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: prompted-seg-service
    container_name: prompted-seg-service
    volumes:
      - coral-data:/data
      - ./prompted-seg-service/weights:/app/weights
      - ./prompted-seg-service/configs:/app/configs
    environment:
      - REDIS_URL=redis://redis:${REDIS_PORT}
      - PORT=${PROMPTED_SEG_PORT}
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run --upgrade fastapi run main.py --port ${PROMPTED_SEG_PORT}

  # prompted-worker:
  #   image: prompted-seg-service # Reuses the image built above
  #   container_name: prompted-worker
  #   environment:
  #     - REDIS_URL=redis://redis:${REDIS_PORT}
  #   networks:
  #     - coral-network
  #   restart: unless-stopped
  #   # -Q defines the queue, -c 1 limits to 1 simultaneous heavy task
  #   command: uv run celery -A app.services.celery_app.celery worker -Q prompted_queue -c 1 --loglevel=info
  #   depends_on:
  #     - redis
  #     - prompted-seg-service

  # 2. Semantic Segmentation
  semantic-seg-service:
    build:
      context: ./semantic-seg-service
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: semantic-seg-service
    container_name: semantic-seg-service
    volumes:
      - coral-data:/data
    environment:
      - REDIS_URL=redis://redis:${REDIS_PORT}
      - PYTHONUNBUFFERED=1
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run --upgrade fastapi run main.py --host localhost --port ${SEMANTIC_SEG_PORT}

  semantic-worker:
    image: semantic-seg-service
    container_name: semantic-worker
    volumes:
      - coral-data:/data
    environment:
      - REDIS_URL=redis://redis:${REDIS_PORT}
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run celery -A celery_app.celery_app worker -Q semantic_queue -c 1 --loglevel=info
    depends_on:
      - redis
      - semantic-seg-service

  # 3. Instance Discovery
  instance-discovery-service:
    build:
      context: ./instance-discovery-service
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: instance-discovery-service
    container_name: instance-discovery-service
    volumes:
      - coral-data:/data
      - ./instance-discovery-service/weights:/app/weights
      - hf-cache:/root/.cache/huggingface
    environment:
      - REDIS_URL=redis://redis:${REDIS_PORT}
      - HF_ACCESS_TOKEN=${HF_ACCESS_TOKEN}
      - HF_HOME=/root/.cache/huggingface
      - TRANSFORMERS_CACHE=/root/.cache/huggingface/transformers
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run --upgrade fastapi run main.py --port ${INSTANCE_DISC_PORT}

  # discovery-worker:
  #   image: instance-discovery-service
  #   container_name: discovery-worker
  #   environment:
  #     - REDIS_URL=redis://redis:${REDIS_PORT}
  #   networks:
  #     - coral-network
  #   restart: unless-stopped
  #   command: uv run celery -A app.services.celery_app.celery worker -Q discovery_queue -c 1 --loglevel=info
  #   depends_on:
  #     - redis
  #     - instance-discovery-service

volumes:
  coral-data:
    driver: local
  hf-cache:
    driver: local

networks:
  coral-network:
    driver: bridge