services:
  # --- INFRASTRUCTURE ---
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - coral-network
    restart: unless-stopped

  # --- FRONTEND & BACKEND ---
  frontend-react:
    build:
      context: ./frontend-react
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL:-http://localhost:4001}
        - REACT_APP_WS_URL=${REACT_APP_WS_URL:-ws://localhost:4001}
        - PUBLIC_URL=${PUBLIC_URL:-/}
    image: frontend-react
    container_name: frontend-react
    ports:
      - "4000:3000"
    environment:
      - NODE_ENV=production
    networks:
      - coral-network
    restart: unless-stopped
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: backend
    container_name: backend
    ports:
      - "4001:8000"
    volumes:
      - coral-data:/data
      - ./backend/logs:/app/logs
    environment:
      - REDIS_URL=redis://redis:6379
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:4000,http://localhost:4003}
      - PROMPTED_SEGMENTATION_BACKEND_URL=http://prompted-seg-service:8001
      - SEMANTIC_SEGMENTATION_BACKEND_URL=http://semantic-seg-service:8002
      - COMPLETION_SEGMENTATION_BACKEND_URL=http://instance-discovery-service:8003
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8000
    depends_on:
      - redis
      - prompted-seg-service
      - semantic-seg-service
      - instance-discovery-service

  # --- AI SERVICES & THEIR DEDICATED WORKERS ---

  # 1. Prompted Segmentation
  prompted-seg-service:
    build:
      context: ./prompted-seg-service
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: prompted-seg-service
    container_name: prompted-seg-service
    environment:
      - REDIS_URL=redis://redis:6379
      - PORT=8001
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run fastapi run main.py --port 8001

  # prompted-worker:
  #   image: prompted-seg-service # Reuses the image built above
  #   container_name: prompted-worker
  #   environment:
  #     - REDIS_URL=redis://redis:6379
  #   networks:
  #     - coral-network
  #   restart: unless-stopped
  #   # -Q defines the queue, -c 1 limits to 1 simultaneous heavy task
  #   command: uv run celery -A app.services.celery_app.celery worker -Q prompted_queue -c 1 --loglevel=info
  #   depends_on:
  #     - redis
  #     - prompted-seg-service

  # 2. Semantic Segmentation
  semantic-seg-service:
    build:
      context: ./semantic-seg-service
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: semantic-seg-service
    container_name: semantic-seg-service
    environment:
      - REDIS_URL=redis://redis:6379
      - PYTHONUNBUFFERED=1
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8002

  semantic-worker:
    image: semantic-seg-service
    container_name: semantic-worker
    environment:
      - REDIS_URL=redis://redis:6379
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run celery -A app.services.celery_app.celery worker -Q semantic_queue -c 1 --loglevel=info
    depends_on:
      - redis
      - semantic-seg-service

  # 3. Instance Discovery
  instance-discovery-service:
    build:
      context: ./instance-discovery-service
      args:
        - GITHUB_TOKEN=${GITHUB_TOKEN}
    image: instance-discovery-service
    container_name: instance-discovery-service
    environment:
      - REDIS_URL=redis://redis:6379
      - HF_ACCESS_TOKEN=${HF_ACCESS_TOKEN}
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8003

  # discovery-worker:
  #   image: instance-discovery-service
  #   container_name: discovery-worker
  #   environment:
  #     - REDIS_URL=redis://redis:6379
  #   networks:
  #     - coral-network
  #   restart: unless-stopped
  #   command: uv run celery -A app.services.celery_app.celery worker -Q discovery_queue -c 1 --loglevel=info
  #   depends_on:
  #     - redis
  #     - instance-discovery-service

volumes:
  coral-data:
    driver: local

networks:
  coral-network:
    driver: bridge