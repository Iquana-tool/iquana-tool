services:
  # Frontend - React Application
  coral-front:
    build:
      context: ./coral-front
      dockerfile: Dockerfile
      args:
       
        - REACT_APP_API_BASE_URL=${REACT_APP_API_BASE_URL:-http://localhost:5018}
        - REACT_APP_WS_URL=${REACT_APP_WS_URL:-ws://localhost:5018}
        - PUBLIC_URL=${PUBLIC_URL:-/}
    image: coral-front
    container_name: coral-front
    ports:
      - "5017:3000"  # Only frontend exposed
    environment:
      - NODE_ENV=production
    networks:
      - coral-network
    restart: unless-stopped
    depends_on:
      - coral-back
    labels:
      - "authors=dev-team"

  # Backend API - Main Application Backend
  coral-back:
    build:
      context: ./coral-back
      dockerfile: Dockerfile
    image: coral-back
    container_name: coral-back
    ports:
      - "5018:8000"  # Only backend exposed
    volumes:
      - coral-data:/data
      - ./coral-back/logs:/app/logs
    environment:
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:7000}
      - PROMPTED_SEGMENTATION_BACKEND_URL=${PROMPTED_SEGMENTATION_BACKEND_URL:-http://coral-prompted-seg:8001}
      - AUTOMATIC_SEGMENTATION_BACKEND_URL=${AUTOMATIC_SEGMENTATION_BACKEND_URL:-http://coral-semantic-seg:7000}
      - COMPLETION_SEGMENTATION_BACKEND_URL=${COMPLETION_SEGMENTATION_BACKEND_URL:-http://coral-completion-seg:8003}
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8000
    depends_on:
      - coral-prompted-seg
      - coral-semantic-seg
      - coral-completion-seg

  # Prompted Segmentation Service (Internal Only)
  coral-prompted-seg:
    build:
      context: ./coral-prompted-seg
      dockerfile: Dockerfile
      ssh:
        - default
    image: coral-prompted-seg
    container_name: coral-prompted-seg
    expose:
      - "8001"  # Exposed only to Docker network, not to host
    volumes:
      - coral-data:/data
      - ./coral-prompted-seg/weights:/app/weights
      - ./coral-prompted-seg/configs:/app/configs
      - ./coral-prompted-seg/logs:/app/logs
    environment:
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:8000,http://localhost:3000}
      - PORT=${PROMPTED_PORT:-8001}
      - LOG_DIR=/app/logs
      - HYDRA_CONFIGS_DIR=/app/configs
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run fastapi run main.py --port 8001

  # Semantic/Automatic Segmentation Service (Internal Only)
  coral-semantic-seg:
    build:
      context: ./coral-semantic-seg
      dockerfile: Dockerfile
    image: coral-semantic-seg
    container_name: coral-semantic-seg
    expose:
      - "7000"  # Exposed only to Docker network, not to host
    volumes:
      - coral-data:/data
      - ./coral-semantic-seg/logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:8000,http://localhost:3000}
    networks:
      - coral-network
    restart: unless-stopped
    command: uvicorn main:app --host 0.0.0.0 --port 7000

  # Completion Segmentation Service (Internal Only)
  coral-completion-seg:
    build:
      context: ./coral-completion-seg
      dockerfile: Dockerfile
      ssh:
        - default
    image: coral-completion-seg
    container_name: coral-completion-seg
    expose:
      - "8003"  # Exposed only to Docker network, not to host
    volumes:
      - coral-data:/data
      - ./coral-completion-seg/weights:/app/weights
      - ./coral-completion-seg/logs:/app/logs
    environment:
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:8000,http://localhost:3000}
      - PORT=${COMPLETION_PORT:-8003}
      - LOG_DIR=/app/logs
      - HF_ACCESS_TOKEN=${HF_ACCESS_TOKEN}
    networks:
      - coral-network
    restart: unless-stopped
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8003

volumes:
  coral-data:
    driver: local

networks:
  coral-network:
    driver: bridge
